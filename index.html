<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·šä¸Šé»é¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* (ä¿ç•™ä½ åŸæœ‰çš„ CSS æ¨£å¼) */
        :root { --primary-color: #0d6efd; --danger-color: #dc3545; }
        body { padding-bottom: 100px; background-color: #f8f9fa; }
        .product-card { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .product-thumb { width: 70px; height: 70px; background-color: #eee; border-radius: 6px; background-size: cover; background-position: center; margin-right: 15px; }
        .cart-fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4); z-index: 1000; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border-radius: 50%; padding: 4px 8px; font-size: 0.8rem; border: 2px solid white; }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 2000; display:flex; justify-content:center; align-items:center; color:white; flex-direction:column; }
        
        .profile-section { background: white; padding: 15px; margin-bottom: 15px; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; justify-content: space-between; }
        .user-info { display: flex; align-items: center; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .order-history-btn { font-size: 0.9rem; color: var(--primary-color); border: 1px solid var(--primary-color); padding: 5px 10px; border-radius: 20px; text-decoration: none; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-light mb-3"></div>
    <div id="loading-text">LINE ç™»å…¥ä¸­...</div>
</div>

<div class="profile-section hidden" id="profile-section">
    <div class="user-info">
        <img id="user-avatar" src="" class="user-avatar">
        <div>
            <div class="fw-bold" id="user-name">Guest</div>
            <small class="text-muted">æ­¡è¿å…‰è‡¨</small>
        </div>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="openOrderHistory()">ğŸ“œ è¨‚å–®è¨˜éŒ„</button>
    </div>
</div>

<div class="container">
    <div id="category-container" class="d-flex gap-2 overflow-auto mb-3 py-2"></div>
    <input type="text" id="search-input" class="form-control mb-3 rounded-pill" placeholder="ğŸ” æœå°‹å•†å“..." oninput="renderProducts()">
    <div id="product-list"></div>
</div>

<div class="cart-fab hidden" id="cart-fab" onclick="cartModal.show()">
    <i class="bi bi-cart-fill"></i>
    <span class="cart-badge hidden" id="cart-count">0</span>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title fw-bold">è³¼ç‰©æ¸…å–®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="cart-body"></div>
            <div class="modal-footer flex-column">
                <div class="d-flex justify-content-between w-100 mb-3"><span class="text-muted">ç¸½è¨ˆ</span><span class="h4 fw-bold text-danger" id="cart-total">$0</span></div>
                <button class="btn btn-success w-100 py-2 fw-bold" onclick="submitOrder()">âœ… é€å‡ºè¨‚å–®</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title fw-bold">æ­·å²è¨‚å–®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body bg-light" id="history-body" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- è¨­å®š ---
    const LIFF_ID = "2009014517-qshUmlAc";
    // ä½ çš„ Apps Script ç¶²å€ (éƒ¨ç½²ç‚º Web App å¾Œçš„ URL)
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx0na9Xn30yu0uRmIoOEvLdhYwq6PUM51pgIo3WA30E3gKj3LG6drnPfhsWy-GPDqXW/exec"; 

    let liffProfile = null;
    let products = [], categories = [], cart = [];
    const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
    const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));

    window.onload = async function() {
        // 1. åˆå§‹åŒ– LIFF
        await initLIFF();
        
        // 2. è¼‰å…¥æœ¬åœ°è³¼ç‰©è»Š
        localforage.config({name: 'POS_Client'});
        cart = await localforage.getItem('cart') || [];
        updateCartUI();

        // 3. è¼‰å…¥å•†å“è³‡æ–™
        loadData();
    };

    async function initLIFF() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login(); // å¼·åˆ¶ç™»å…¥
            } else {
                liffProfile = await liff.getProfile();
                document.getElementById('user-name').innerText = liffProfile.displayName;
                document.getElementById('user-avatar').src = liffProfile.pictureUrl;
                document.getElementById('profile-section').classList.remove('hidden');
                document.getElementById('loading-text').innerText = "æ›´æ–°èœå–®...";
            }
        } catch (err) {
            console.error(err);
            alert("LINE åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹åœ¨ LINE å…§é–‹å•Ÿ");
        }
    }

    async function loadData() {
        try {
            const res = await fetch(GAS_API_URL + "?page=json");
            const data = await res.json();
            products = data.products;
            categories = data.categories;
            renderCategories();
            renderProducts();
            toggleLoading(false);
        } catch(e) { alert("é€£ç·šéŒ¯èª¤"); toggleLoading(false); }
    }

    // --- è¨‚å–®é€å‡ºé‚è¼¯ (é—œéµä¿®æ”¹) ---
    async function submitOrder() {
        if(cart.length === 0) return;
        if(!liffProfile) return alert("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š");

        if(!confirm("ç¢ºå®šè¦é€å‡ºè¨‚å–®å—ï¼Ÿ")) return;

        toggleLoading(true, "è¨‚å–®å‚³é€ä¸­...");
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.count), 0);
        const itemsStr = cart.map(i => `${i.name} x${i.count}`).join("\n");
        
        const orderData = {
            userId: liffProfile.userId,
            displayName: liffProfile.displayName,
            itemsStr: itemsStr,
            total: total,
            cartItems: cart // å‚³é€å®Œæ•´ç‰©ä»¶ä»¥ä¾¿å¾Œç«¯æ‰£åº«å­˜
        };

        try {
            // ä½¿ç”¨ POST é€å‡ºè³‡æ–™åˆ° GAS
            const response = await fetch(GAS_API_URL, {
                method: "POST",
                mode: "no-cors", // GAS é™åˆ¶ï¼Œå¿…é ˆç”¨ no-corsï¼Œå› æ­¤ç„¡æ³•è®€å–å›å‚³å€¼ï¼Œä½†ä¸å½±éŸ¿å¯«å…¥
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: "createOrder",
                    order: orderData
                })
            });

            // å› ç‚º no-cors ä¸æœƒå›å‚³ jsonï¼Œæˆ‘å€‘å‡è¨­åªè¦æ²’å ±éŒ¯å°±æ˜¯æˆåŠŸ
            cart = [];
            await localforage.setItem('cart', cart);
            updateCartUI();
            cartModal.hide();
            toggleLoading(false);
            
            alert("âœ… è¨‚å–®å·²é€å‡ºï¼\næˆ‘å€‘æœƒç›¡å¿«è™•ç†æ‚¨çš„è¨‚å–®ã€‚");
            
            // å¯ä»¥é¸æ“‡é—œé–‰è¦–çª—æˆ–è·³è½‰
            // liff.closeWindow(); 
        } catch (e) {
            toggleLoading(false);
            alert("âŒ è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦: " + e);
        }
    }

    // --- æŸ¥è©¢è¨‚å–®è¨˜éŒ„ ---
    async function openOrderHistory() {
        if(!liffProfile) return;
        toggleLoading(true, "è®€å–è¨˜éŒ„...");
        try {
            const res = await fetch(`${GAS_API_URL}?page=myOrders&uid=${liffProfile.userId}`);
            const orders = await res.json();
            
            const container = document.getElementById('history-body');
            container.innerHTML = '';
            
            if(orders.length === 0) {
                container.innerHTML = '<div class="text-center py-5 text-muted">ç›®å‰æ²’æœ‰è¨‚å–®è¨˜éŒ„</div>';
            } else {
                orders.forEach(o => {
                    let badgeClass = 'bg-secondary';
                    if(o.status === 'è™•ç†ä¸­') badgeClass = 'bg-primary';
                    if(o.status === 'å·²å®Œæˆ') badgeClass = 'bg-success';
                    
                    const div = document.createElement('div');
                    div.className = 'card p-3 mb-2 border-0 shadow-sm';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge ${badgeClass}">${o.status}</span>
                            <small class="text-muted">${o.date.split(' ')[0]}</small>
                        </div>
                        <div class="fw-bold mb-1">${o.id}</div>
                        <div class="small text-muted mb-2" style="white-space: pre-wrap;">${o.items}</div>
                        <div class="text-end fw-bold text-danger">ç¸½è¨ˆ $${o.total}</div>
                    `;
                    container.appendChild(div);
                });
            }
            toggleLoading(false);
            historyModal.show();
        } catch(e) {
            toggleLoading(false);
            alert("è®€å–å¤±æ•—");
        }
    }

    // --- åŸºç¤ UI é‚è¼¯ (ä¿ç•™åŸæ¨£) ---
    function renderCategories() {
        const c = document.getElementById('category-container'); c.innerHTML='';
        categories.forEach(cat => {
            c.innerHTML += `<button class="btn btn-light border rounded-pill text-nowrap" onclick="filterCat('${cat}')">${cat}</button>`;
        });
    }
    function renderProducts(catFilter = null) {
        const list = document.getElementById('product-list'); list.innerHTML='';
        const key = document.getElementById('search-input').value.toLowerCase();
        products.forEach(p => {
            if(catFilter && p.cat !== catFilter) return;
            if(key && !p.name.includes(key)) return;
            const img = p.img ? `background-image:url('${p.img}')` : '';
            const qty = cart.find(x=>x.name===p.name)?.count || 0;
            list.innerHTML += `
                <div class="product-card">
                    <div class="product-thumb" style="${img}"></div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${p.name}</div>
                        <div class="text-danger fw-bold">$${p.price}</div>
                        <small class="text-muted">åº«å­˜: ${p.stock}</small>
                    </div>
                    <div>
                        ${qty>0 ? `<span class="badge bg-primary me-2">${qty}</span>` : ''}
                        <button class="btn btn-sm btn-outline-primary rounded-circle" onclick="addToCart('${p.name}')" ${p.stock<=0?'disabled':''}>+</button>
                    </div>
                </div>`;
        });
    }
    function filterCat(cat){ renderProducts(cat); }
    
    function addToCart(name) {
        const p = products.find(x=>x.name===name);
        const item = cart.find(x=>x.name===name);
        if(item) {
            if(item.count >= p.stock) return alert("åº«å­˜ä¸è¶³");
            item.count++;
        } else {
            cart.push({name: p.name, price: p.price, cat: p.cat, count: 1});
        }
        saveCart();
    }
    
    function updateCartUI() {
        const fab = document.getElementById('cart-fab');
        const badge = document.getElementById('cart-count');
        const count = cart.reduce((s,i)=>s+i.count,0);
        
        if(count > 0) { fab.classList.remove('hidden'); badge.classList.remove('hidden'); badge.innerText = count; }
        else { fab.classList.add('hidden'); }
        
        const body = document.getElementById('cart-body'); body.innerHTML = '';
        let total = 0;
        cart.forEach((item, idx) => {
            total += item.price * item.count;
            body.innerHTML += `
                <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                    <div>
                        <div class="fw-bold">${item.name}</div>
                        <small>$${item.price}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-sm btn-light" onclick="modQty(${idx},-1)">-</button>
                        <span class="mx-2">${item.count}</span>
                        <button class="btn btn-sm btn-light" onclick="modQty(${idx},1)">+</button>
                    </div>
                </div>`;
        });
        document.getElementById('cart-total').innerText = '$' + total;
        if(cart.length===0) body.innerHTML='<div class="text-center text-muted">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
    }
    
    function modQty(idx, delta) {
        cart[idx].count += delta;
        if(cart[idx].count <= 0) cart.splice(idx, 1);
        saveCart();
    }
    
    async function saveCart() { await localforage.setItem('cart', cart); updateCartUI(); renderProducts(); }
    function toggleLoading(s,t) { document.getElementById('loading-overlay').classList.toggle('hidden', !s); if(t)document.getElementById('loading-text').innerText=t; }

</script>
</body>
</html>
