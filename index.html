<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¨‚æ£®è‰¯é¸ Lifestyle Select</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <style>
        :root { --primary: #d32f2f; var(--accent): #ffb300; var(--bg-warm): #fffdf5; var(--text-dark): #3e2723; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-warm); color: var(--text-dark); padding-bottom: 100px; overflow-x: hidden; }
        .marquee-container { background: #ffc107; color: #000; padding: 10px 0; overflow: hidden; white-space: nowrap; position: relative; z-index: 1030; font-size: 1rem; font-weight: 900; border-bottom: 2px solid #000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; overflow: hidden; }
        .dog-wrapper { position: relative; width: 100%; height: 180px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        .loader-img { position: absolute; width: 180px; height: auto; object-fit: contain; animation: runRightToLeft 7s linear infinite; }
        .main-dog { z-index: 10; opacity: 1; }
        .ghost-1 { z-index: 9; opacity: 0.6; animation-delay: -0.15s; filter: blur(1px); }
        .ghost-2 { z-index: 8; opacity: 0.3; animation-delay: -0.3s; filter: blur(2px); }
        .ghost-3 { z-index: 7; opacity: 0.1; animation-delay: -0.45s; filter: blur(4px); }
        @keyframes runRightToLeft { 0% { transform: translateX(120vw); } 100% { transform: translateX(-120vw); } }
        
        /* ğŸŸ¢ Header æ¨£å¼èª¿æ•´é–‹å§‹ */
        .hero-section { background: white; padding: 15px 20px; position: relative; z-index: 1020; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; flex-grow: 1; justify-content: center; } /* è®“åœ–ç‰‡åœ¨å€å¡Šå…§å±…ä¸­ */
        
        /* Banner åœ–ç‰‡éŸ¿æ‡‰å¼è¨­å®š */
        .hero-banner-img {
            width: auto;           /* å¯¬åº¦è‡ªå‹•æŠ“å–æ¯”ä¾‹ */
            height: auto;          /* é«˜åº¦è‡ªå‹•æŠ“å–æ¯”ä¾‹ */
            max-width: 100%;       /* ç¢ºä¿å¯¬åº¦ä¸è¶…å‡ºè¢å¹• */
            max-height: 120px;     /* æ‰‹æ©Ÿé è¨­æœ€å¤§é«˜åº¦ */
            object-fit: contain;   /* ä¿æŒåœ–ç‰‡å®Œæ•´æ¯”ä¾‹é¡¯ç¤º */
            transition: 0.3s;      /* åŠ å…¥å¹³æ»‘éæ¸¡æ•ˆæœ */
        }

        /* ç•¶è¢å¹•å¯¬åº¦å¤§æ–¼ 768px (å¹³æ¿/é›»è…¦) æ™‚é©ç”¨ */
        @media (min-width: 768px) {
            .hero-banner-img {
                max-height: 200px; /* é›»è…¦ç‰ˆå…è¨±æ›´å¤§çš„é«˜åº¦ */
            }
        }
        /* ğŸŸ¢ Header æ¨£å¼èª¿æ•´çµæŸ */

        .user-block { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; color: #888; cursor: pointer; flex-shrink: 0; margin-left: 10px; } 
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; margin-bottom: 2px;}
        .quick-menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px 15px 10px 15px; }
        .menu-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .menu-item:active { transform: scale(0.95); opacity: 0.8; }
        .menu-btn-img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .menu-label { font-size: 0.9rem; font-weight: 700; color: var(--text-dark); }
        .cat-nav { display: flex; overflow-x: auto; white-space: nowrap; padding: 12px 15px; gap: 8px; position: sticky; top: 0; z-index: 1010; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .cat-nav::-webkit-scrollbar { display: none; }
        .cat-pill { padding: 6px 16px; background: #fff; color: var(--text-dark); border: 1px solid #e0e0e0; border-radius: 20px; font-size: 0.9rem; font-weight: 700; transition: 0.2s; }
        .cat-pill.active { background: var(--text-dark); color: var(--accent); border-color: var(--text-dark); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .section-title { font-weight: 800; margin: 20px 0 10px 0; padding-left: 15px; border-left: 5px solid var(--accent); font-size: 1.2rem; color: var(--text-dark); }
        .product-card { background: white; border-radius: 15px; overflow: hidden; border: none; box-shadow: 0 3px 10px rgba(0,0,0,0.05); margin-bottom: 15px; position: relative; }
        .product-img { width: 100%; height: 140px; object-fit: cover; background: #eee; }
        .product-body { padding: 12px; position: relative; }
        .product-name { font-size: 0.95rem; font-weight: bold; margin-bottom: 5px; color: #4e342e; }
        .product-price { color: var(--primary); font-size: 1.1rem; font-weight: 900; }
        .stock-info { font-size: 0.75rem; color: #888; background: #f5f5f5; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-top: 4px; }
        .badge-corner { position: absolute; top: 0; right: 0; background: #d32f2f; color: white; font-size: 0.8rem; font-weight: bold; padding: 5px 10px; border-bottom-left-radius: 10px; z-index: 10; box-shadow: -2px 2px 5px rgba(0,0,0,0.2); }
        .product-card.oos-mode .product-img { opacity: 0.5; filter: grayscale(100%); }
        .btn-add-only { position: absolute; bottom: 10px; right: 10px; width: 32px; height: 32px; background: var(--accent); color: var(--text-dark); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.15); cursor: pointer; }
        .qty-group { position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; background: #fff; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); border: 1px solid var(--accent); }
        .qty-btn { width: 28px; height: 28px; border: none; background: var(--accent); color: var(--text-dark); font-weight: bold; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; }
        .qty-val { font-size: 0.9rem; font-weight: bold; width: 24px; text-align: center; }
        .cart-bar { position: fixed; bottom: 25px; left: 5%; width: 90%; background: #3e2723; color: #ffffff; border-radius: 50px; padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 1050; cursor: pointer; transition: 0.3s; transform: translateY(150%); border: 2px solid #ffb300; box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.85), 0 12px 25px rgba(0,0,0,0.6); }
        .cart-bar.show { transform: translateY(0); }
        .cart-bar-total { color: #ffb300; font-weight: 900; font-size: 1.25rem; }
        .btn-confirm { background: var(--primary); color: white; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); }
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; cursor: zoom-out; }
        #lightbox img { max-width: 90%; max-height: 80%; border-radius: 8px; transform: scale(0.9); transition: 0.3s; }
        #lightbox.show img { transform: scale(1); }
        .order-item-list { list-style: none; padding: 0; margin: 5px 0; }
        .order-item-list li { padding: 4px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; display: flex; justify-content: space-between; }
        .order-item-list li:last-child { border-bottom: none; }
        .item-qty-badge { background-color: #3e2723; color: #ffb300; padding: 1px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .variant-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .variant-row:last-child { border-bottom: none; }
        .qty-stepper { display: flex; align-items: center; background: #f8f9fa; border-radius: 20px; border: 1px solid #ddd; }
        .step-btn { width: 30px; height: 30px; border: none; background: transparent; color: #333; font-weight: bold; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .step-val { width: 30px; text-align: center; font-weight: bold; font-size: 1rem; }
        .variant-tag { font-size: 0.75rem; background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        .cart-item-row.clearance-item {
            background-color: #fff3cd; 
            border-left: 5px solid #dc3545; 
            padding-left: 10px;
            margin-bottom: 4px;
            border-radius: 4px;
        }
        .item-index { font-weight: 900; color: #aaa; min-width: 25px; font-size: 1rem; }
        .clearance-badge { font-size: 0.8rem; background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: bold; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="loader"><div class="dog-wrapper"><img src="https://drive.google.com/thumbnail?id=1-bdeExYe6cZArJ6G_f3oO3qmu4TfXGK_&sz=w1000" class="loader-img ghost-3" referrerpolicy="no-referrer"><img src="https://drive.google.com/thumbnail?id=1-bdeExYe6cZArJ6G_f3oO3qmu4TfXGK_&sz=w1000" class="loader-img ghost-2" referrerpolicy="no-referrer"><img src="https://drive.google.com/thumbnail?id=1-bdeExYe6cZArJ6G_f3oO3qmu4TfXGK_&sz=w1000" class="loader-img ghost-1" referrerpolicy="no-referrer"><img src="https://drive.google.com/thumbnail?id=1-bdeExYe6cZArJ6G_f3oO3qmu4TfXGK_&sz=w1000" class="loader-img main-dog" alt="Loading" referrerpolicy="no-referrer"></div><div class="spinner-border text-warning" role="status"></div><div class="mt-2 text-secondary fw-bold small">æ¨‚æ£®è‰¯é¸ ç‚ºæ‚¨æœå‹™...</div></div>
<div id="marquee-bar" class="marquee-container"><div id="marquee-text" class="marquee-content"></div></div>
<div id="update-time-banner" style="display:none">åº«å­˜æ›´æ–°ï¼š<span id="stock-time"></span></div>

<div class="hero-section">
    <div class="header-left">
        <img src="https://drive.google.com/thumbnail?id=1vRTh5gAxbj-CpVtHBbwltWeMYmQwG6Do&sz=w2000" class="hero-banner-img" alt="æ¨‚æ£®è‰¯é¸ Lifestyle Select" referrerpolicy="no-referrer">
    </div>
    <div class="user-block" onclick="handleUserBlockClick()">
        <img src="https://placehold.co/100x100?text=Guest" class="user-avatar" id="user-avatar">
        <div class="mt-1" id="user-name">è¨ªå®¢</div>
    </div>
</div>

<div class="quick-menu">
    <div class="menu-item" onclick="openCartModal()"><img src="https://drive.google.com/thumbnail?id=1xM2Zbn4YW06eGcmWPV0DTQG6yQlDgTAd&sz=w1000" class="menu-btn-img" referrerpolicy="no-referrer"><div class="menu-label">ç«‹å³çµå¸³</div></div>
    <div class="menu-item" onclick="openMyOrders()"><img src="https://drive.google.com/thumbnail?id=1-gXteiqgQi24r2ZuljHT8f5hj1ntk_Rn&sz=w1000" class="menu-btn-img" referrerpolicy="no-referrer"><div class="menu-label">æŸ¥è©¢è¨‚å–®</div></div>
    <div class="menu-item" onclick="openSupport()"><img src="https://drive.google.com/thumbnail?id=1SITi3RtcBJuShqo7kSRCS3JjP-zujbZ0&sz=w1000" class="menu-btn-img" referrerpolicy="no-referrer"><div class="menu-label">è¯çµ¡å®¢æœ</div></div>
</div>

<div class="cat-nav" id="cat-nav"></div>
<div class="container mt-2" id="product-container"></div>

<div class="cart-bar" id="cart-bar" onclick="openCartModal()"><div class="d-flex align-items-center"><span class="badge bg-danger rounded-pill me-2 fs-6" id="cart-count">0</span><span class="fw-bold">å»çµå¸³</span></div><span class="cart-bar-total" id="cart-total">$0</span></div>

<div class="modal fade" id="logoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold">æœƒå“¡åŠŸèƒ½</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body d-grid gap-2">
                <button class="btn btn-primary" onclick="openMyOrders(); bootstrap.Modal.getInstance(document.getElementById('logoutModal')).hide();">
                    <i class="bi bi-file-earmark-text me-2"></i>æŸ¥è©¢æ­·å²è¨‚å–®
                </button>
                <button class="btn btn-outline-danger" onclick="performLogout()">
                    <i class="bi bi-box-arrow-right me-2"></i>ç™»å‡º (åˆ‡æ›ç‚ºè¨ªå®¢)
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title fw-bold text-dark"><i class="bi bi-basket-fill text-danger"></i> è³¼ç‰©æ¸…å–®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div id="guest-login-prompt" style="display:none;" class="mb-3 p-3 bg-light rounded border border-success text-center">
                    <div class="fw-bold text-success mb-2">ğŸ‘‹ å°šæœªç™»å…¥ LINE</div>
                    <button class="btn btn-success w-100 fw-bold" onclick="loginWithLine()"><i class="bi bi-line me-2"></i>LINE ç™»å…¥ (æ¨è–¦)</button>
                    <div class="text-muted small mt-2">ç™»å…¥å¾Œå¯è¿½è¹¤è¨‚å–®ç‹€æ…‹èˆ‡ç´¯ç©é»æ•¸</div>
                </div>
                <div id="cart-modal-body"></div>
            </div>
            <div class="px-3 pb-3 bg-white border-top">
                <div class="mt-3"><label class="form-label small fw-bold text-secondary">å–é¤è¯çµ¡äºº <span class="text-danger">*</span></label><input type="text" id="order-contact-name" class="form-control rounded-pill bg-light" placeholder="è«‹è¼¸å…¥å§“å"></div>
                <div class="mt-2"><label class="form-label small fw-bold text-secondary">è¯çµ¡é›»è©± <span class="text-danger">*</span></label><input type="tel" id="order-contact-phone" class="form-control rounded-pill bg-light" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼"></div>
            </div>
            <div class="modal-footer border-0 pt-0 d-block">
                <div class="d-flex justify-content-between align-items-center mb-3"><span class="text-secondary fw-bold">ç¸½è¨ˆé‡‘é¡</span><span class="h3 fw-bold text-danger m-0" id="modal-cart-total">$0</span></div>
                <button class="btn btn-confirm w-100 py-2 rounded-pill fs-5" id="btn-submit-order" onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="variantModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="variant-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="variant-list"></div>
            <div class="modal-footer border-0 pt-0">
                <button class="btn btn-dark w-100 rounded-pill" onclick="confirmVariantSelection()">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="announceModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title fw-bold text-danger">ğŸ“¢ å„ªæƒ æ´»å‹• / å…¬å‘Š</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="announce-img-container" style="display:none;"></div><div id="announce-content" class="mt-2 text-center fw-bold text-dark"></div></div><div class="modal-footer border-0"><button type="button" class="btn btn-warning w-100 rounded-pill fw-bold text-dark" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button></div></div></div></div>
<div class="modal fade" id="myOrdersModal" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold">ğŸ¶ æ­·å²è¨‚å–®æŸ¥è©¢</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light" id="my-orders-list"></div></div></div></div>
<div id="lightbox" onclick="closeLightbox()"><img id="lightbox-img" src="" alt="æ”¾å¤§åœ–ç‰‡"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const LIFF_ID = "2009042792-5xuNohp3";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxD140v33ChZm1tQsuW1jbwd5R14QTGyeFHWBSU8zkg41ortc_9Zra3T4pF1lL-ZjyA/exec";

    let allData = {}; let cart = [];
    let userProfile = { userId: 'guest', displayName: 'è¨ªå®¢' }; 
    let currentCategory = 'top10'; 
    let tempNormalQty = 0, tempClearanceQty = 0, tempProduct = null;
    let isLoggedIn = false; 

    const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
    const myOrdersModal = new bootstrap.Modal(document.getElementById('myOrdersModal'));
    const announceModal = new bootstrap.Modal(document.getElementById('announceModal'));
    const variantModal = new bootstrap.Modal(document.getElementById('variantModal'));
    const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));

    window.onload = function() { 
        loadCartFromLocal(); 
        fetchMenu(); 
        initLiff(); 
    };

    async function initLiff() { 
        try { 
            await liff.init({ liffId: LIFF_ID }); 
            if (liff.isLoggedIn()) { 
                const p = await liff.getProfile(); 
                userProfile = p; 
                isLoggedIn = true;
                updateUserUI(true);
            } else { 
                isLoggedIn = false;
                updateUserUI(false);
            } 
        } catch (e) { 
            console.error("LIFF Error:", e);
            // ğŸŸ¢ å¦‚æœåˆå§‹åŒ–å¤±æ•—ï¼Œå¼·åˆ¶åˆ‡æ›å›è¨ªå®¢æ¨¡å¼ï¼Œé¿å…å¡æ­»
            isLoggedIn = false;
            updateUserUI(false);
        } 
    }

    function updateUserUI(isLogin) {
        if(isLogin) {
            document.getElementById('user-name').innerText = userProfile.displayName;
            if(userProfile.pictureUrl) document.getElementById('user-avatar').src = userProfile.pictureUrl;
        } else {
            document.getElementById('user-name').innerText = "è¨ªå®¢ (é»æ“Šç™»å…¥)";
            document.getElementById('user-avatar').src = "https://placehold.co/100x100?text=Guest";
        }
    }

    function handleUserBlockClick() {
        if (!isLoggedIn) {
            loginWithLine();
        } else {
            logoutModal.show();
        }
    }

    // ğŸŸ¢ ç™»å‡ºä¿®æ­£ï¼šå¼·åˆ¶å›åˆ°ä¹¾æ·¨çš„ URLï¼Œé¿å…åƒæ•¸æ®˜ç•™å°è‡´éŒ¯èª¤
    function performLogout() {
        if (liff.isLoggedIn()) {
            liff.logout();
        }
        localStorage.removeItem('pos_cart'); 
        // ç§»é™¤ ?code=... ç­‰åƒæ•¸
        window.location.href = window.location.href.split('?')[0]; 
    }

    function loginWithLine() {
        saveCartToLocal(); 
        liff.login({ redirectUri: window.location.href });
    }

    function saveCartToLocal() { localStorage.setItem('pos_cart', JSON.stringify(cart)); }
    function loadCartFromLocal() {
        const saved = localStorage.getItem('pos_cart');
        if (saved) {
            try { cart = JSON.parse(saved); updateCartUI(); } catch(e) { console.log("Cart load error"); }
        }
    }
    
    function fetchMenu() {
        fetch(GAS_URL + "?page=json&t=" + Date.now()).then(res => res.json()).then(data => {
                if (data.error) { alert("å¾Œç«¯éŒ¯èª¤: " + data.message); return; }
                allData = data; 
                if(data.marqueeText && data.marqueeText.trim() !== "") { document.getElementById('marquee-text').innerText = data.marqueeText; document.getElementById('marquee-bar').style.display = 'block'; }
                if(data.lastUpdateTime) { document.getElementById('stock-time').innerText = data.lastUpdateTime; document.getElementById('update-time-banner').style.display = 'block'; }
                renderMenu(); checkAnnouncement(data); document.getElementById('loader').style.display = 'none';
        }).catch(err => { document.getElementById('loader').innerHTML = '<div class="text-danger p-4 text-center"><h3>è¼‰å…¥å¤±æ•—</h3><br>è«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯ç¹«ç®¡ç†å“¡<br><small>' + err + '</small></div>'; });
    }

    function checkAnnouncement(data) { const hasText = data.announcementText && data.announcementText.trim() !== ""; const hasImg = data.announcementImg && data.announcementImg.trim() !== ""; if (hasText || hasImg) { document.getElementById('announce-content').innerText = data.announcementText || ""; const imgDiv = document.getElementById('announce-img-container'); if (hasImg) { imgDiv.innerHTML = `<img src="${data.announcementImg}" referrerpolicy="no-referrer" style="width:100%; border-radius:15px;">`; imgDiv.style.display = "block"; } else { imgDiv.innerHTML = ""; imgDiv.style.display = "none"; } announceModal.show(); } }
    function openSupport() { window.location.href = 'https://line.me/R/ti/p/@lawsonshop'; }
    function setCategory(cat) { currentCategory = cat; renderMenu(); }
    
    function renderMenu() {
        const nav = document.getElementById('cat-nav'); const container = document.getElementById('product-container');
        
        // æ™ºæ…§åˆ¤æ–·ï¼šæª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å•†å“çš„å³æœŸåº«å­˜ > 0
        const hasClearanceItems = allData.products.some(p => Number(p.clearStock) > 0);

        let navHtml = `<span class="cat-pill ${currentCategory === 'top10' ? 'active' : ''}" onclick="setCategory('top10')">ğŸ”¥ ç†±éŠ·TOP10</span>`;
        
        // åªæœ‰ç•¶æœ‰å³æœŸå“æ™‚ï¼Œæ‰é¡¯ç¤ºæŒ‰éˆ•
        if (hasClearanceItems) {
            navHtml += `<span class="cat-pill ${currentCategory === 'expiry' ? 'active' : ''}" onclick="setCategory('expiry')">âš ï¸ å³æœŸè‰¯å“</span>`;
        }

        navHtml += `<span class="cat-pill ${currentCategory === 'all' ? 'active' : ''}" onclick="setCategory('all')">å…¨éƒ¨å•†å“</span>`;
        if (allData.categories) { allData.categories.forEach(cat => { navHtml += `<span class="cat-pill ${currentCategory === cat ? 'active' : ''}" onclick="setCategory('${cat}')">${cat}</span>`; }); }
        nav.innerHTML = navHtml; container.innerHTML = '';
        if (!allData.categories || allData.categories.length === 0) { container.innerHTML = '<div class="text-center mt-5 text-muted">ç›®å‰æ²’æœ‰å•†å“</div>'; return; }

        let items = [];
        if (currentCategory === 'top10') items = allData.products.filter(p => allData.top10.includes(p.name)); 
        else if (currentCategory === 'expiry') items = allData.products.filter(p => Number(p.clearStock) > 0); 
        else {
            allData.categories.forEach(cat => {
                if (currentCategory !== 'all' && currentCategory !== cat) return;
                const catItems = allData.products.filter(p => p.cat === cat); if(catItems.length === 0) return;
                let grouped = {}; catItems.forEach(p => { const sub = p.subCat || 'å…¶ä»–'; if(!grouped[sub]) grouped[sub] = []; grouped[sub].push(p); });
                let html = `<div id="cat-${cat}" class="section-title">${cat}</div>`;
                for (const [subName, subItems] of Object.entries(grouped)) {
                    if(subName && subName !== '') html += `<div class="sub-cat-title text-secondary small fw-bold mb-2 ms-2"><i class="bi bi-tag-fill me-1"></i>${subName}</div>`; 
                    html += `<div class="row g-3">`; subItems.forEach(p => html += createProductCard(p)); html += `</div>`; 
                } container.innerHTML += html;
            });
            return;
        }

        if (items.length === 0) { container.innerHTML = '<div class="text-center mt-5 text-muted">ç›®å‰æ²’æœ‰ç›¸é—œå•†å“</div>'; return; }
        let html = `<div class="section-title">${currentCategory === 'top10' ? 'ğŸ”¥ ç†±éŠ·æ¨è–¦' : 'âš ï¸ å³æœŸè‰¯å“å°ˆå€'}</div><div class="row g-3">`; 
        items.forEach(p => html += createProductCard(p)); 
        html += `</div>`; container.innerHTML = html;
    }

    function createProductCard(p) {
        const inCart = cart.find(c => c.name === p.name && c.cat === p.cat);
        const count = inCart ? inCart.count : 0; 
        
        // åº«å­˜åˆ¤æ–·ï¼šéœ€åŒæ™‚æª¢æŸ¥æ­£å¸¸èˆ‡å³æœŸ
        const isOOS = p.status === 'oos' || (p.stock <= 0 && (!p.clearStock || Number(p.clearStock) <= 0));
        
        const imgHtml = p.img ? `<img src="${p.img}" class="product-img" onclick="zoomImg(event, '${p.img}')" referrerpolicy="no-referrer">` : `<div class="product-img d-flex align-items-center justify-content-center text-muted"><i class="bi bi-camera fs-1"></i></div>`;
        let stockHtml = `<span class="stock-info">å‰©: ${p.stock}</span>`;
        
        const hasClearanceOption = (Number(p.clearStock) > 0);
        let btnHtml = '';

        if (isOOS) {
            btnHtml = `<span class="badge bg-secondary position-absolute bottom-0 end-0 m-2">è£œè²¨ä¸­</span>`;
        } else if (hasClearanceOption) {
            btnHtml = `<div class="btn-add-only" style="width:auto; padding:0 12px; border-radius:20px; font-size:0.9rem;" onclick="openVariantModal('${p.name}', '${p.cat}')">é¸è³¼</div>`;
        } else {
            btnHtml = (count > 0 ? `<div class="qty-group"><button class="qty-btn" onclick="updateQty('${p.name}', '${p.cat}', -1)">-</button><span class="qty-val">${count}</span><button class="qty-btn" onclick="updateQty('${p.name}', '${p.cat}', 1)">+</button></div>` : `<div class="btn-add-only" onclick="updateQty('${p.name}', '${p.cat}', 1)"><i class="bi bi-plus-lg"></i></div>`);
        }

        let cornerBadgeHtml = '';
        // æ¨™ç±¤é¡¯ç¤ºï¼šåš´æ ¼åªçœ‹å³æœŸåº«å­˜ > 0
        if (Number(p.clearStock) > 0) { 
            cornerBadgeHtml = `<div class="badge-corner">å³æœŸå‡ºæ¸…</div>`; 
        } 
        
        const cardClass = isOOS ? 'oos-mode' : ''; 
        
        return `
        <div class="col-6 col-md-4">
            <div class="product-card ${cardClass}">
                <div class="position-relative">${cornerBadgeHtml}${imgHtml}</div>
                <div class="product-body">
                    <div class="product-name text-truncate">${p.name}</div>
                    <div class="product-price">$${p.price}</div>
                    ${stockHtml}
                    ${btnHtml}
                </div>
            </div>
        </div>`;
    }

    function openVariantModal(name, cat) {
        tempProduct = allData.products.find(x => x.name === name && x.cat === cat);
        if (!tempProduct) return;
        
        tempNormalQty = 0;
        tempClearanceQty = 0;
        document.getElementById('variant-title').innerText = tempProduct.name;
        renderVariantModal();
        variantModal.show();
    }

    function renderVariantModal() {
        const list = document.getElementById('variant-list');
        list.innerHTML = '';
        
        let dateStr = '';
        if (tempProduct.arrivalDate) {
            const d = new Date(tempProduct.arrivalDate);
            if (!isNaN(d.getTime())) { dateStr = `æ•ˆæœŸ: ${(d.getMonth()+1)}/${d.getDate()}`; }
        }

        if (tempProduct.stock > 0) {
            list.innerHTML += `
            <div class="variant-row">
                <div class="flex-grow-1">
                    <div class="fw-bold">æ­£å¸¸å“ <small class="text-muted fw-normal">å‰©${tempProduct.stock}</small></div>
                    <div class="text-danger fw-bold">$${tempProduct.price}</div>
                </div>
                <div class="qty-stepper">
                    <button class="step-btn" onclick="updateTempQty('normal', -1)">-</button>
                    <div class="step-val">${tempNormalQty}</div>
                    <button class="step-btn" onclick="updateTempQty('normal', 1)">+</button>
                </div>
            </div>`;
        }
        
        if (Number(tempProduct.clearStock) > 0) {
            list.innerHTML += `
            <div class="variant-row">
                <div class="flex-grow-1">
                    <div class="fw-bold text-danger">å³æœŸå“ <span class="variant-tag">${dateStr}</span></div>
                    <div class="text-danger fw-bold">$${tempProduct.clearPrice} <small class="text-muted fw-normal">å‰©${tempProduct.clearStock}</small></div>
                </div>
                <div class="qty-stepper">
                    <button class="step-btn" onclick="updateTempQty('clearance', -1)">-</button>
                    <div class="step-val">${tempClearanceQty}</div>
                    <button class="step-btn" onclick="updateTempQty('clearance', 1)">+</button>
                </div>
            </div>`;
        }
    }

    function updateTempQty(type, delta) {
        if (type === 'normal') {
            const newQty = tempNormalQty + delta;
            if (newQty >= 0 && newQty <= tempProduct.stock) tempNormalQty = newQty;
        } else {
            const newQty = tempClearanceQty + delta;
            if (newQty >= 0 && newQty <= tempProduct.clearStock) tempClearanceQty = newQty;
        }
        renderVariantModal();
    }

    function confirmVariantSelection() {
        if (tempNormalQty === 0 && tempClearanceQty === 0) {
            variantModal.hide();
            return;
        }
        
        if (tempNormalQty > 0) addToCart(tempProduct.name, tempProduct.cat, tempProduct.price, tempNormalQty);
        if (tempClearanceQty > 0) addToCart(tempProduct.name + " (å³æœŸå“)", tempProduct.cat, tempProduct.clearPrice, tempClearanceQty);
        
        variantModal.hide();
    }

    function addToCart(name, cat, price, qty) {
        const idx = cart.findIndex(c => c.name === name && c.cat === cat);
        if (idx > -1) {
            cart[idx].count += qty;
        } else {
            cart.push({ name: name, price: price, cat: cat, count: qty });
        }
        updateCartUI();
        saveCartToLocal(); 
    }

    function updateQty(name, cat, delta) { 
        const product = allData.products.find(p => p.name === name && p.cat === cat);
        const idx = cart.findIndex(c => c.name === name && c.cat === cat); 
        
        if (delta > 0) {
            const currentQty = idx > -1 ? cart[idx].count : 0;
            if (currentQty >= product.stock) {
                alert(`åº«å­˜ä¸è¶³ï¼ç›®å‰å‰©é¤˜ ${product.stock} å€‹`);
                return;
            }
        }

        if (idx > -1) { 
            cart[idx].count += delta;
            if (cart[idx].count <= 0) cart.splice(idx, 1); 
        } else if (delta > 0) { 
            cart.push({ name, price: product.price, cat, count: 1 });
        } 
        
        updateCartUI();
        saveCartToLocal(); 
        renderMenu(); 
        if(document.getElementById('cartModal').classList.contains('show')) renderCartModal(); 
    }

    function updateCartUI() { const total = cart.reduce((s, i) => s + (i.price * i.count), 0); const count = cart.reduce((s, i) => s + i.count, 0); document.getElementById('cart-count').innerText = count; document.getElementById('cart-total').innerText = '$' + total; document.getElementById('modal-cart-total').innerText = '$' + total; document.getElementById('cart-bar').classList.toggle('show', count > 0); if (count === 0) cartModal.hide(); }
    function openCartModal() { renderCartModal(); cartModal.show(); }
    
    function renderCartModal() { 
        const body = document.getElementById('cart-modal-body');
        
        const loginPrompt = document.getElementById('guest-login-prompt');
        const submitBtn = document.getElementById('btn-submit-order');
        if (isLoggedIn) {
            loginPrompt.style.display = 'none';
            submitBtn.innerText = "é€å‡ºè¨‚å–®";
            submitBtn.classList.remove('btn-secondary');
            submitBtn.classList.add('btn-confirm');
        } else {
            loginPrompt.style.display = 'block';
            submitBtn.innerText = "ä»¥è¨ªå®¢èº«åˆ†é€å–®";
            submitBtn.classList.remove('btn-confirm');
            submitBtn.classList.add('btn-secondary');
        }

        if (cart.length === 0) { body.innerHTML = '<div class="text-center py-4 text-muted">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>'; return; } 
        
        let html = ''; 
        
        cart.forEach((i, index) => {
            const isClearance = i.name.includes('(å³æœŸå“)');
            const rowClass = isClearance ? 'cart-item-row clearance-item' : 'cart-item-row border-bottom';
            const badgeHtml = isClearance ? `<span class="clearance-badge">âš ï¸ å³æœŸè‰¯å“</span>` : ``;
            
            let dateInfo = '';
            if (isClearance) {
                const rawName = i.name.replace(" (å³æœŸå“)", "");
                const p = allData.products.find(x => x.name === rawName && x.cat === i.cat);
                if (p && p.arrivalDate) {
                    const d = new Date(p.arrivalDate);
                    if (!isNaN(d.getTime())) { dateInfo = `<div class="small text-danger fw-bold"><i class="bi bi-calendar-event"></i> æ•ˆæœŸï¼š${d.getMonth()+1}/${d.getDate()}</div>`; }
                }
            }

            html += `
            <div class="d-flex justify-content-between align-items-center py-2 ${rowClass}">
                <div class="me-2 item-index">${index + 1}.</div>
                <div style="flex:1">
                    <div>${badgeHtml} <span class="fw-bold text-dark">${i.name.replace(" (å³æœŸå“)", "")}</span></div>
                    ${dateInfo}
                    <small class="text-secondary fw-bold">$${i.price}</small>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-warning text-dark border fw-bold rounded-circle" style="width:28px;height:28px;padding:0" onclick="updateQtyInCart('${i.name}','${i.cat}',-1)">-</button>
                    <span class="px-3 fw-bold">${i.count}</span>
                    <button class="btn btn-sm btn-warning text-dark fw-bold rounded-circle" style="width:28px;height:28px;padding:0" onclick="updateQtyInCart('${i.name}','${i.cat}',1)">+</button>
                </div>
            </div>`;
        });
        
        body.innerHTML = html;
    }

    function updateQtyInCart(displayName, cat, delta) {
        const rawName = displayName.replace(" (å³æœŸå“)", "").trim();
        const product = allData.products.find(p => p.name === rawName && p.cat === cat);
        const isClearance = displayName.includes('(å³æœŸå“)');
        const idx = cart.findIndex(c => c.name === displayName && c.cat === cat);
        const currentQty = idx > -1 ? cart[idx].count : 0;

        if (delta > 0 && product) {
            const maxStock = isClearance ? product.clearStock : product.stock;
            if (currentQty >= maxStock) {
                alert(`åº«å­˜ä¸è¶³ï¼ç›®å‰å‰©é¤˜ ${maxStock} å€‹`);
                return;
            }
        }

        if (idx > -1) {
            cart[idx].count += delta;
            if (cart[idx].count <= 0) cart.splice(idx, 1);
        }
        
        updateCartUI();
        saveCartToLocal(); 
        renderCartModal();
    }
    
    function submitOrder() {
        const cName = document.getElementById('order-contact-name').value.trim(); const cPhone = document.getElementById('order-contact-phone').value.trim();
        if (!cName) { alert("è«‹è¼¸å…¥å–é¤è¯çµ¡äººå§“å"); return; } if (!cPhone) { alert("è«‹è¼¸å…¥è¯çµ¡é›»è©±"); return; }
        
        let confirmMsg = "ç¢ºèªé€å‡ºè¨‚å–®ï¼Ÿ";
        if (!isLoggedIn) {
            confirmMsg = "âš ï¸ æ‚¨ç›®å‰æ˜¯è¨ªå®¢èº«åˆ†ï¼Œå°‡ç„¡æ³•æ”¶åˆ°è¨‚å–®ç‹€æ…‹é€šçŸ¥ã€‚\n\nç¢ºå®šè¦é€å‡ºå—ï¼Ÿ";
        }

        if(!confirm(confirmMsg)) return;
        document.getElementById('loader').style.display = 'flex'; document.querySelector('#loader .fw-bold').innerText = "ç‹—ç‹—è·‘è…¿é€å–®ä¸­..."; cartModal.hide();
        const orderData = { action: 'createOrder', order: { userId: userProfile.userId, displayName: userProfile.displayName, itemsStr: cart.map(i => `${i.name} x${i.count}`).join(', '), total: cart.reduce((s, i) => s + (i.price * i.count), 0), cartItems: cart, contactName: cName, contactPhone: cPhone } };
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(orderData), mode: 'no-cors' }).then(() => { alert("ğŸ‰ è¨‚å–®å·²é€å‡ºï¼"); cart = []; saveCartToLocal(); updateCartUI(); renderMenu(); document.getElementById('loader').style.display = 'none'; }).catch(e => alert("éŒ¯èª¤: " + e));
    }
    
    function zoomImg(e, url) { e.stopPropagation(); const lb = document.getElementById('lightbox'); document.getElementById('lightbox-img').src = url; lb.style.display = 'flex'; setTimeout(() => lb.classList.add('show'), 10); }
    function closeLightbox() { const lb = document.getElementById('lightbox'); lb.classList.remove('show'); setTimeout(() => lb.style.display = 'none', 300); }
    
    function openMyOrders() { 
        if(!isLoggedIn) { alert("è«‹å…ˆç™»å…¥ LINE æ‰èƒ½æŸ¥è©¢è¨‚å–®ï¼"); return; }
        myOrdersModal.show(); document.getElementById('my-orders-list').innerHTML = '<div class="text-center py-3">è¼‰å…¥ä¸­...</div>';
        fetch(GAS_URL + "?page=myOrders&uid=" + userProfile.userId + "&t=" + Date.now()).then(res => res.json()).then(orders => { 
            if(!orders || orders.length === 0) { document.getElementById('my-orders-list').innerHTML = '<div class="text-center py-3 text-muted">å°šç„¡è¨‚å–®ç´€éŒ„</div>'; return; }
            let html = '';
            orders.forEach(o => {
                let itemsHtml = '<ul class="order-item-list">';
                const itemsArray = o.items.split(','); 
                itemsArray.forEach(itemStr => { 
                    const parts = itemStr.split(' x'); const name = parts[0].trim(); const qty = parts[1] ? parts[1].trim() : '1'; 
                    const nameDisplay = name.includes('(å³æœŸå“)') ? `<span class="text-danger fw-bold">${name}</span>` : name;
                    itemsHtml += `<li><span>${nameDisplay}</span><span class="item-qty-badge">x${qty}</span></li>`; 
                });
                itemsHtml += '</ul>';
                html += `<div class="card mb-3 border-0 shadow-sm"><div class="card-header bg-white d-flex justify-content-between align-items-center"><span class="badge ${o.status === 'å·²å®Œæˆ' ? 'bg-success' : 'bg-warning text-dark'}">${o.status}</span><small class="text-secondary">${o.date}</small></div><div class="card-body p-3"><div class="d-flex justify-content-between align-items-center mb-2"><span class="fw-bold text-dark">#${o.id}</span><span class="text-danger fw-bold">$${o.total}</span></div><div class="bg-light p-2 rounded">${itemsHtml}</div></div></div>`;
            });
            document.getElementById('my-orders-list').innerHTML = html;
        }).catch(err => { document.getElementById('my-orders-list').innerHTML = '<div class="text-center text-danger">è¼‰å…¥å¤±æ•—</div>'; });
    }
</script>
</body>
</html>
