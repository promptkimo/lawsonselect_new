<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·šä¸Šé»é¤ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <style>
        body { font-family: sans-serif; background-color: #f8f9fa; padding-bottom: 100px; }
        .hero { background: white; padding: 15px; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #ddd; }
        .cat-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; }
        .cat-btn { white-space: nowrap; padding: 5px 15px; background: #eee; border-radius: 20px; text-decoration: none; color: #333; }
        .cat-btn.active { background: #333; color: white; }
        .prod-card { background: white; border-radius: 10px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .prod-img { width: 100%; height: 150px; object-fit: cover; background: #ddd; }
        .cart-bar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: #dc3545; color: white; padding: 15px; border-radius: 50px; display: none; justify-content: space-between; align-items: center; cursor: pointer; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-danger mb-3"></div>
    <div id="loading-msg">ç³»çµ±è¼‰å…¥ä¸­...</div>
</div>

<div class="hero">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0 fw-bold" id="store-title">æ­¡è¿å…‰è‡¨</h5>
        <small id="user-name" class="badge bg-light text-dark border">è¨ªå®¢</small>
    </div>
    <div class="cat-scroll" id="cat-nav"></div>
</div>

<div class="container mt-3" id="product-container"></div>

<div class="cart-bar" id="cart-bar" onclick="submitOrder()">
    <strong>æŸ¥çœ‹è³¼ç‰©è»Š (<span id="cart-count">0</span>)</strong>
    <strong id="cart-total">$0</strong>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ğŸ”´ 1. å¼·åˆ¶é™¤éŒ¯ï¼šç¢ºèª JS æœ‰è·‘
    console.log("=== ç¨‹å¼é–‹å§‹åŸ·è¡Œ ===");

    // è¨­å®š
    const LIFF_ID = "2009014517-qshUmlAc";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxD140v33ChZm1tQsuW1jbwd5R14QTGyeFHWBSU8zkg41ortc_9Zra3T4pF1lL-ZjyA/exec";

    let allData = {};
    let cart = [];
    let userProfile = { userId: 'guest', displayName: 'è¨ªå®¢' };

    // 2. åˆå§‹åŒ–
    window.onload = function() {
        console.log("ç¶²é è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æŠ“å–è³‡æ–™...");
        
        // å„ªå…ˆæŠ“èœå–®
        fetchMenu();
        
        // èƒŒæ™¯ç™»å…¥ LIFF
        initLiff();
    };

    async function initLiff() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const p = await liff.getProfile();
                userProfile = p;
                document.getElementById('user-name').innerText = p.displayName;
                console.log("LIFF ç™»å…¥æˆåŠŸ:", p);
            } else {
                console.log("LIFF æœªç™»å…¥");
            }
        } catch (e) {
            console.error("LIFF éŒ¯èª¤:", e);
        }
    }

    function fetchMenu() {
        document.getElementById('loading-msg').innerText = "æ­£åœ¨é€£ç·šè³‡æ–™åº«...";
        
        fetch(GAS_URL + "?page=json&t=" + Date.now())
            .then(res => res.json())
            .then(data => {
                console.log("æ”¶åˆ° GAS è³‡æ–™:", data);
                allData = data;
                document.getElementById('store-title').innerText = data.appTitle || 'ç·šä¸Šé»é¤';
                renderMenu();
                document.getElementById('loader').style.display = 'none';
            })
            .catch(err => {
                console.error("GAS é€£ç·šå¤±æ•—:", err);
                alert("é€£ç·šå¤±æ•—ï¼è«‹æŒ‰ F12 çœ‹ Console éŒ¯èª¤è¨Šæ¯");
                document.getElementById('loading-msg').innerHTML = `<span class="text-danger">ç„¡æ³•é€£ç·š<br>è«‹ç¢ºèªå¾Œå°éƒ¨ç½²æ¬Šé™</span>`;
            });
    }

    function renderMenu() {
        const nav = document.getElementById('cat-nav');
        const box = document.getElementById('product-container');
        
        if (!allData.categories || allData.categories.length === 0) {
            box.innerHTML = '<div class="text-center mt-5">ç›®å‰ç„¡å•†å“</div>';
            return;
        }

        nav.innerHTML = '<a href="#" class="cat-btn active" onclick="filterCat(\'all\',this)">å…¨éƒ¨</a>';
        box.innerHTML = '';

        allData.categories.forEach(cat => {
            nav.innerHTML += `<a href="#cat-${cat}" class="cat-btn" onclick="setActive(this)">${cat}</a>`;
            const items = allData.products.filter(p => p.cat === cat);
            
            let html = `<h6 id="cat-${cat}" class="mt-4 fw-bold border-start border-4 border-danger ps-2">${cat}</h6><div class="row g-3">`;
            items.forEach(p => {
                const isOOS = p.status === 'oos';
                html += `
                <div class="col-6 col-md-4">
                    <div class="prod-card" onclick="addToCart('${p.name}', ${p.price}, '${cat}')">
                        ${p.img ? `<img src="${p.img}" class="prod-img">` : `<div class="prod-img"></div>`}
                        <div class="p-2">
                            <div class="fw-bold text-truncate">${p.name}</div>
                            <div class="d-flex justify-content-between mt-1">
                                <span class="text-danger fw-bold">$${p.price}</span>
                                ${isOOS ? '<span class="badge bg-secondary">å”®å®Œ</span>' : '<span class="badge bg-danger">+</span>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            box.innerHTML += html;
        });
    }

    function setActive(el) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function addToCart(name, price, cat) {
        const exist = cart.find(i => i.name === name && i.cat === cat);
        if(exist) exist.count++; else cart.push({name, price, cat, count:1});
        updateCart();
    }

    function updateCart() {
        const total = cart.reduce((acc, i) => acc + (i.price * i.count), 0);
        const count = cart.reduce((acc, i) => acc + i.count, 0);
        document.getElementById('cart-total').innerText = '$' + total;
        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-bar').style.display = count > 0 ? 'flex' : 'none';
    }

    function submitOrder() {
        if(!confirm(`ç¢ºèªé€å‡ºè¨‚å–®ï¼Ÿç¸½é¡ $${document.getElementById('cart-total').innerText}`)) return;
        
        const loader = document.getElementById('loader');
        loader.style.display = 'flex';
        document.getElementById('loading-msg').innerText = "è¨‚å–®å‚³é€ä¸­...";

        const orderData = {
            action: 'createOrder',
            order: {
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                itemsStr: cart.map(i => `${i.name} x${i.count}`).join(', '),
                total: cart.reduce((acc, i) => acc + (i.price * i.count), 0)
            }
        };

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(orderData),
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'}
        }).then(() => {
            alert("è¨‚å–®å·²é€å‡ºï¼");
            cart = []; updateCart();
            loader.style.display = 'none';
        }).catch(e => {
            alert("éŒ¯èª¤: " + e);
            loader.style.display = 'none';
        });
    }
</script>
</body>
</html>
