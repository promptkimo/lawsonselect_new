<script>
    // ä½ çš„è¨­å®š
    const LIFF_ID = "2009014517-qshUmlAc"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxD140v33ChZm1tQsuW1jbwd5R14QTGyeFHWBSU8zkg41ortc_9Zra3T4pF1lL-ZjyA/exec";

    let allData = {};
    let cart = []; 
    let userProfile = { userId: 'guest', displayName: 'è¨ªå®¢', pictureUrl: '' };
    const myOrdersModal = new bootstrap.Modal(document.getElementById('myOrdersModal'));

    // 1. åˆå§‹åŒ– (ä¸¦è¡Œè™•ç†ï¼šåŒæ™‚æŠ“èœå–® + åŒæ™‚ç™»å…¥ LINE)
    window.onload = function() {
        console.log("é–‹å§‹è¼‰å…¥...");
        
        // A. å„ªå…ˆè¼‰å…¥èœå–® (ä¸ç®¡ LIFF æœ‰æ²’æœ‰æˆåŠŸï¼Œéƒ½è¦å…ˆè®“å®¢äººçœ‹åˆ°èœå–®)
        fetchMenu();

        // B. å˜—è©¦ç™»å…¥ LIFF (åªç‚ºäº†æ‹¿é ­è²¼å’Œåå­—)
        initLiff();
    };

    async function initLiff() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                userProfile = profile;
                // æ›´æ–°é ­åƒä»‹é¢
                document.getElementById('user-name').innerText = profile.displayName;
                if(profile.pictureUrl) document.getElementById('user-img').src = profile.pictureUrl;
                console.log("LIFF ç™»å…¥æˆåŠŸ");
            } else {
                // æœªç™»å…¥ (çœ‹ä½ è¦ä¸è¦å¼·åˆ¶è·³è½‰ï¼Œæˆ–ä¿æŒè¨ªå®¢)
                // liff.login(); 
                console.log("LIFF æœªç™»å…¥ï¼Œä¿æŒè¨ªå®¢æ¨¡å¼");
            }
        } catch (e) {
            console.error("LIFF åˆå§‹åŒ–å¤±æ•— (å¯èƒ½æ˜¯ ID éŒ¯æˆ–ç’°å¢ƒå•é¡Œ):", e);
        }
    }

    // 2. æŠ“å–èœå–®
    function fetchMenu() {
        console.log("æ­£åœ¨é€£ç·š GAS...");
        // åŠ ä¸Š timestamp é˜²æ­¢å¿«å–
        fetch(GAS_URL + "?page=json&t=" + new Date().getTime())
            .then(res => res.json())
            .then(data => {
                console.log("GAS è³‡æ–™è¼‰å…¥æˆåŠŸ:", data);
                allData = data;
                document.getElementById('store-title').innerText = data.appTitle || 'ç·šä¸Šé»é¤';
                renderMenu();
                // éš±è—è¼‰å…¥å‹•ç•«
                document.getElementById('loader').style.display = 'none';
            })
            .catch(err => {
                console.error("GAS é€£ç·šå¤±æ•—:", err);
                alert("è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯ï¼Œæˆ–ç¢ºèª GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦ç‚ºã€Œæ‰€æœ‰äººã€ã€‚");
                document.getElementById('loader').innerHTML = '<div class="text-danger p-4 text-center">ç„¡æ³•é€£ç·šä¼ºæœå™¨<br>è«‹ç¢ºèª GAS éƒ¨ç½²è¨­å®š</div>';
            });
    }

    // 3. æ¸²æŸ“å•†å“
    function renderMenu() {
        const nav = document.getElementById('cat-nav');
        const container = document.getElementById('product-container');
        
        if (!allData.categories || allData.categories.length === 0) {
            container.innerHTML = '<div class="text-center mt-5">ç›®å‰æ²’æœ‰ä¸Šæ¶å•†å“</div>';
            return;
        }

        nav.innerHTML = `<a href="#" class="cat-pill active" onclick="filterCat('all', this)">å…¨éƒ¨</a>`;
        container.innerHTML = '';

        allData.categories.forEach(cat => {
            nav.innerHTML += `<a href="#cat-${cat}" class="cat-pill" onclick="setActive(this)">${cat}</a>`;
            const items = allData.products.filter(p => p.cat === cat);
            if(items.length === 0) return;

            let html = `<div id="cat-${cat}" class="section-title">${cat}</div><div class="row g-3">`;
            
            items.forEach(p => {
                const isOOS = p.status === 'oos';
                // æª¢æŸ¥è³¼ç‰©è»Šå…§æ˜¯å¦æœ‰æ­¤å•†å“
                const inCartItem = cart.find(c => c.name === p.name && c.cat === cat);
                const count = inCartItem ? inCartItem.count : 0;
                
                // æ±ºå®šæŒ‰éˆ•æ¨£å¼
                let btnHtml = '';
                if (!isOOS) {
                    if (count > 0) {
                        btnHtml = `
                        <div class="qty-control">
                            <button class="qty-btn" onclick="updateQty('${p.name}', '${cat}', -1)">-</button>
                            <span class="qty-num">${count}</span>
                            <button class="qty-btn" onclick="updateQty('${p.name}', '${cat}', 1)">+</button>
                        </div>`;
                    } else {
                        btnHtml = `<div class="btn-add-only" onclick="updateQty('${p.name}', '${cat}', 1)"><i class="bi bi-plus-lg"></i></div>`;
                    }
                }

                const imgHtml = p.img 
                    ? `<img src="${p.img}" class="product-img">` 
                    : `<div class="product-img d-flex align-items-center justify-content-center text-muted"><i class="bi bi-cup-straw fs-1"></i></div>`;

                html += `
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="product-card ${isOOS ? 'oos' : ''}">
                        <div class="position-relative">
                            ${imgHtml}
                            ${isOOS ? `<span class="oos-badge">å”®å®Œ</span>` : ''}
                        </div>
                        <div class="product-body">
                            <div class="product-name text-truncate">${p.name}</div>
                            <div class="product-price">$${p.price}</div>
                            ${btnHtml}
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    function setActive(el) {
        document.querySelectorAll('.cat-pill').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    // 4. æ›´æ–°æ•¸é‡é‚è¼¯
    function updateQty(name, cat, delta) {
        const product = allData.products.find(p => p.name === name && p.cat === cat);
        if (!product) return;

        const itemIndex = cart.findIndex(c => c.name === name && c.cat === cat);
        
        if (itemIndex > -1) {
            cart[itemIndex].count += delta;
            if (cart[itemIndex].count <= 0) cart.splice(itemIndex, 1);
        } else if (delta > 0) {
            cart.push({ name, price: product.price, cat, count: 1 });
        }
        
        renderMenu(); 
        updateCartUI();
    }

    function updateCartUI() {
        const total = cart.reduce((sum, i) => sum + (i.price * i.count), 0);
        const count = cart.reduce((sum, i) => sum + i.count, 0);

        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-total').innerText = '$' + total;

        const bar = document.getElementById('cart-bar');
        if (count > 0) bar.classList.add('show');
        else bar.classList.remove('show');
    }

    // 5. é€å‡ºè¨‚å–®
    function submitOrder() {
        if(!confirm(`ç¢ºå®šé€å‡ºè¨‚å–®ï¼Ÿ\nç¸½é‡‘é¡: $${document.getElementById('cart-total').innerText}`)) return;

        const total = cart.reduce((sum, i) => sum + (i.price * i.count), 0);
        const itemsStr = cart.map(i => `${i.name} x${i.count}`).join(', ');

        const orderData = {
            action: 'createOrder',
            order: {
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                itemsStr: itemsStr,
                total: total
            }
        };

        const loader = document.getElementById('loader');
        loader.innerHTML = '<div class="spinner-border text-danger"></div><div class="mt-2 fw-bold">è¨‚å–®å‚³é€ä¸­...</div>';
        loader.style.display = 'flex';

        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(orderData),
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' }
        }).then(() => {
            alert('ğŸ‰ è¨‚å–®å·²é€å‡ºï¼');
            cart = [];
            renderMenu();
            updateCartUI();
            loader.style.display = 'none';
        }).catch(err => {
            alert('âŒ ç™¼ç”ŸéŒ¯èª¤: ' + err);
            loader.style.display = 'none';
        });
    }

    // 6. æŸ¥è©¢æ­·å²è¨‚å–®
    function openMyOrders() {
        myOrdersModal.show();
        const list = document.getElementById('my-orders-list');
        list.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-secondary"></div><div class="mt-2 text-muted">è¼‰å…¥ä¸­...</div></div>';

        fetch(GAS_URL + "?page=myOrders&uid=" + userProfile.userId)
            .then(res => res.json())
            .then(orders => {
                list.innerHTML = '';
                if (orders.length === 0) {
                    list.innerHTML = '<div class="text-center py-5 text-muted">æ‚¨é‚„æ²’æœ‰è¨‚å–®ç´€éŒ„</div>';
                    return;
                }
                orders.forEach(o => {
                    let badgeClass = 'bg-secondary';
                    if (o.status === 'å¾…è™•ç†') badgeClass = 'badge-pending';
                    if (o.status === 'è™•ç†ä¸­') badgeClass = 'badge-processing';
                    if (o.status === 'å·²å®Œæˆ') badgeClass = 'badge-completed';

                    list.innerHTML += `
                    <div class="order-history-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge ${badgeClass}">${o.status}</span>
                            <small class="text-muted">${o.date.split(' ')[0]}</small>
                        </div>
                        <div class="fw-bold mb-1">è¨‚å–®ç·¨è™Ÿ: ${o.id}</div>
                        <div class="bg-white border rounded p-2 text-secondary small mb-2">${o.items}</div>
                        <div class="text-end fw-bold text-danger">$${o.total}</div>
                    </div>`;
                });
            })
            .catch(err => {
                console.error(err);
                list.innerHTML = '<div class="text-danger text-center">ç„¡æ³•è¼‰å…¥è¨‚å–® (GAS æ¬Šé™å¯èƒ½æœªé–‹)</div>';
            });
    }
</script>
