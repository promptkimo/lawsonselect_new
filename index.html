<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·šä¸Šé»é¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    
    <style>
        :root { --primary: #e23744; /* Foodpanda Red ish */ --dark: #2d2d2d; --light: #f7f7f7; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--light); padding-bottom: 80px; }
        
        /* æ©«å¹… Header */
        .hero-section { background: white; padding: 20px 15px 10px 15px; position: sticky; top:0; z-index: 1020; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .store-title { font-weight: 800; font-size: 1.5rem; color: var(--dark); margin-bottom: 5px; }

        /* åˆ†é¡å°è¦½ (å¯æ»‘å‹•) */
        .category-nav { display: flex; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; -webkit-overflow-scrolling: touch; gap: 10px; }
        .category-nav::-webkit-scrollbar { display: none; }
        .cat-pill { padding: 6px 16px; background: #f0f0f0; color: #666; border-radius: 20px; font-size: 0.9rem; font-weight: 500; text-decoration: none; border: 1px solid transparent; transition: 0.2s; }
        .cat-pill.active { background: var(--dark); color: white; border-color: var(--dark); }

        /* å•†å“å¡ç‰‡ */
        .section-title { font-weight: 700; margin: 25px 0 15px 0; padding-left: 15px; font-size: 1.2rem; border-left: 4px solid var(--primary); line-height: 1.2; }
        .product-card { background: white; border-radius: 12px; border: none; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: 0.2s; }
        .product-card:active { transform: scale(0.98); }
        .product-img { width: 100%; height: 160px; object-fit: cover; background: #eee; }
        .product-body { padding: 12px; position: relative; }
        .product-name { font-weight: 700; font-size: 1rem; margin-bottom: 4px; color: var(--dark); }
        .product-price { font-weight: 700; color: var(--dark); font-size: 1.1rem; }
        .btn-add { position: absolute; bottom: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: white; border: 1px solid #ddd; color: var(--primary); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-add:active { background: var(--primary); color: white; border-color: var(--primary); }

        /* ç¼ºè²¨æ¨£å¼ */
        .oos { opacity: 0.6; pointer-events: none; filter: grayscale(1); }
        .oos-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; }

        /* åº•éƒ¨è³¼ç‰©è»ŠæŒ‰éˆ• */
        .cart-bar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: var(--primary); color: white; border-radius: 10px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(226, 55, 68, 0.4); z-index: 1050; cursor: pointer; transition: 0.3s; transform: translateY(150%); }
        .cart-bar.show { transform: translateY(0); }
        .cart-count { background: white; color: var(--primary); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; margin-right: 10px; }
        
        /* è³¼ç‰©è»Š Modal */
        .modal-bottom .modal-dialog { position: fixed; bottom: 0; margin: 0; width: 100%; max-width: 100%; }
        .modal-bottom .modal-content { border-radius: 20px 20px 0 0; border: none; height: 80vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; padding: 20px; }
        
        /* è¼‰å…¥ç•«é¢ */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-danger mb-3" role="status"></div>
    <div class="fw-bold text-secondary">è¼‰å…¥èœå–®ä¸­...</div>
</div>

<div class="hero-section">
    <div class="store-title" id="store-title">æ­¡è¿å…‰è‡¨</div>
    <div class="category-nav" id="cat-nav">
        </div>
</div>

<div class="container mt-2" id="product-container">
    </div>

<div class="cart-bar" id="cart-bar" onclick="openCart()">
    <div class="d-flex align-items-center">
        <div class="cart-count" id="cart-count">0</div>
        <div class="fw-bold">æŸ¥çœ‹è³¼ç‰©è»Š</div>
    </div>
    <div class="fw-bold" id="cart-total">$0</div>
</div>

<div class="modal fade modal-bottom" id="cartModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">æ‚¨çš„è¨‚å–®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cart-items-list">
                    </div>
                <div class="mt-4">
                    <label class="form-label text-muted small">è¨‚è³¼äººå§“å (é¸å¡«)</label>
                    <input type="text" id="user-name" class="form-control" placeholder="å¦‚ä½•ç¨±å‘¼æ‚¨?">
                </div>
            </div>
            <div class="modal-footer border-0 p-3 shadow-lg">
                <div class="d-flex justify-content-between w-100 mb-2 align-items-center">
                    <span class="text-muted">ç¸½é‡‘é¡</span>
                    <span class="h4 fw-bold text-danger m-0" id="modal-total">$0</span>
                </div>
                <button class="btn btn-danger w-100 py-3 rounded-pill fw-bold" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allData = {};
    let cart = [];
    let liffProfile = null;
    const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));

    // åˆå§‹åŒ–
    window.onload = function() {
        initLiff();
        fetchData();
    };

    async function initLiff() {
        try {
            await liff.init({ liffId: "ä½ çš„LIFF_ID" }); // ğŸ”´ å¦‚æœä½ æœ‰ LIFF ID å¡«é€™è£¡ï¼Œæ²’æœ‰ä¹Ÿæ²’é—œä¿‚
            if (liff.isLoggedIn()) {
                liffProfile = await liff.getProfile();
                document.getElementById('user-name').value = liffProfile.displayName;
            }
        } catch (e) { console.log('LIFF init failed', e); }
    }

    function fetchData() {
        google.script.run.withSuccessHandler(data => {
            allData = data;
            document.getElementById('store-title').innerText = data.appTitle || 'ç·šä¸Šé»é¤';
            renderMenu();
            document.getElementById('loader').style.display = 'none';
        }).withFailureHandler(alert).getAllData();
    }

    function renderMenu() {
        const nav = document.getElementById('cat-nav');
        const container = document.getElementById('product-container');
        nav.innerHTML = `<a href="#" class="cat-pill active" onclick="filterCat('all', this)">å…¨éƒ¨</a>`;
        container.innerHTML = '';

        // 1. ç”¢ç”Ÿåˆ†é¡æŒ‰éˆ•
        allData.categories.forEach(cat => {
            nav.innerHTML += `<a href="#cat-${cat}" class="cat-pill" onclick="setActive(this)">${cat}</a>`;
        });

        // 2. ç”¢ç”Ÿå•†å“å€å¡Š
        allData.categories.forEach(cat => {
            // æ‰¾å‡ºè©²åˆ†é¡ä¸‹çš„å•†å“
            const items = allData.products.filter(p => p.cat === cat);
            if(items.length === 0) return;

            let html = `<div id="cat-${cat}" class="section-title">${cat}</div><div class="row g-3">`;
            
            items.forEach((p, idx) => {
                const isOOS = p.status === 'oos';
                html += `
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="product-card ${isOOS ? 'oos' : ''}" onclick="addToCart('${p.name}', ${p.price}, '${cat}')">
                        <div class="position-relative">
                            ${p.img ? `<img src="${p.img}" class="product-img">` : `<div class="product-img d-flex align-items-center justify-content-center text-muted"><i class="bi bi-cup-straw fs-1"></i></div>`}
                            ${isOOS ? `<span class="oos-badge">å”®å®Œ</span>` : ''}
                        </div>
                        <div class="product-body">
                            <div class="product-name text-truncate">${p.name}</div>
                            <div class="product-price">$${p.price}</div>
                            ${!isOOS ? `<div class="btn-add"><i class="bi bi-plus-lg"></i></div>` : ''}
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    function setActive(el) {
        document.querySelectorAll('.cat-pill').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    // --- è³¼ç‰©è»Šé‚è¼¯ ---
    function addToCart(name, price, cat) {
        const item = cart.find(i => i.name === name && i.cat === cat);
        if (item) {
            item.count++;
        } else {
            cart.push({ name, price, cat, count: 1 });
        }
        updateCartUI();
    }

    function updateCartUI() {
        const total = cart.reduce((sum, i) => sum + (i.price * i.count), 0);
        const count = cart.reduce((sum, i) => sum + i.count, 0);

        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-total').innerText = '$' + total;
        document.getElementById('modal-total').innerText = '$' + total;

        const bar = document.getElementById('cart-bar');
        if (count > 0) bar.classList.add('show');
        else bar.classList.remove('show');
    }

    function openCart() {
        renderCartItems();
        cartModal.show();
    }

    function renderCartItems() {
        const list = document.getElementById('cart-items-list');
        list.innerHTML = '';
        if(cart.length === 0) { list.innerHTML = '<div class="text-center text-muted py-5">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>'; return; }

        cart.forEach((item, idx) => {
            list.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <div class="text-muted small">$${item.price}</div>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary rounded-circle" style="width:30px;height:30px;padding:0" onclick="changeCount(${idx}, -1)">-</button>
                    <span class="mx-3 fw-bold">${item.count}</span>
                    <button class="btn btn-sm btn-outline-danger rounded-circle" style="width:30px;height:30px;padding:0" onclick="changeCount(${idx}, 1)">+</button>
                </div>
            </div>`;
        });
    }

    function changeCount(idx, delta) {
        cart[idx].count += delta;
        if (cart[idx].count <= 0) cart.splice(idx, 1);
        updateCartUI();
        renderCartItems();
        if (cart.length === 0) cartModal.hide();
    }

    function submitOrder() {
        if (cart.length === 0) return;
        const total = cart.reduce((sum, i) => sum + (i.price * i.count), 0);
        const name = document.getElementById('user-name').value || 'è¨ªå®¢';
        const userId = (liffProfile && liffProfile.userId) ? liffProfile.userId : 'Guest-' + Date.now();
        
        // è£½ä½œè¨‚å–®å­—ä¸²
        const itemsStr = cart.map(i => `${i.name} x${i.count}`).join(', ');

        const order = {
            userId: userId,
            displayName: name,
            itemsStr: itemsStr,
            total: total,
            cartItems: cart // å‚³é€å®Œæ•´ç‰©ä»¶ä»¥ä¾¿å¾Œç«¯æ‰£åº«å­˜
        };

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        const btn = document.querySelector('#cartModal .btn-danger');
        const originText = btn.innerText;
        btn.innerText = 'è¨‚å–®å‚³é€ä¸­...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
            alert('ğŸ‰ è¨‚å–®å·²é€å‡ºï¼\nå–®è™Ÿï¼š' + res.orderId);
            cart = [];
            updateCartUI();
            cartModal.hide();
            btn.innerText = originText;
            btn.disabled = false;
        }).withFailureHandler(err => {
            alert('âŒ å¤±æ•—: ' + err);
            btn.innerText = originText;
            btn.disabled = false;
        }).createOrder(order);
    }
</script>
</body>
</html>
