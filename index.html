<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šé»é¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-bottom: 80px; background-color: #f7f7f7; }
        .hero { background: white; padding: 15px; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cat-nav { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .cat-pill { display: inline-block; padding: 5px 15px; background: #eee; border-radius: 20px; margin-right: 5px; text-decoration: none; color: #333; }
        .cat-pill.active { background: #333; color: white; }
        .prod-card { background: white; border-radius: 10px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .prod-img { width: 100%; height: 150px; object-fit: cover; background: #ddd; }
        .cart-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #e23744; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; cursor: pointer; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="spinner-border text-danger mb-3"></div>
    <div>è¼‰å…¥èœå–®ä¸­...</div>
</div>

<div class="hero">
    <h4 class="fw-bold" id="store-title">æ­¡è¿å…‰è‡¨</h4>
    <div class="cat-nav" id="cat-nav"></div>
</div>

<div class="container mt-3" id="product-list"></div>

<div class="cart-bar" onclick="submitOrder()" id="cart-bar" style="display:none;">
    <div class="fw-bold">æŸ¥çœ‹è³¼ç‰©è»Š & çµå¸³</div>
    <div class="fw-bold" id="cart-total">$0</div>
</div>

<script>
    // ğŸ”´ è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„è³‡æ–™
    const GAS_URL = "https://script.google.com/macros/s/ä½ çš„_GAS_éƒ¨ç½²ç¶²å€/exec"; 
    const LIFF_ID = "ä½ çš„_LIFF_ID"; 

    let allData = {};
    let cart = [];
    let userProfile = { userId: 'guest', displayName: 'è¨ªå®¢' };

    // 1. åˆå§‹åŒ–
    window.onload = async function() {
        // å…ˆå˜—è©¦åˆå§‹åŒ– LIFF
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                userProfile = { userId: profile.userId, displayName: profile.displayName };
                console.log("LIFF ç™»å…¥æˆåŠŸ:", userProfile);
            } else {
                // å¦‚æœæ²’ç™»å…¥ï¼Œå¯ä»¥é¸æ“‡è‡ªå‹•ç™»å…¥ï¼Œæˆ–æ˜¯ä¿æŒè¨ªå®¢æ¨¡å¼
                // liff.login(); 
                console.log("LIFF æœªç™»å…¥ï¼Œä½¿ç”¨è¨ªå®¢æ¨¡å¼");
            }
        } catch (e) {
            console.error("LIFF åˆå§‹åŒ–å¤±æ•—:", e);
        }

        // æ¥è‘—è¼‰å…¥èœå–®
        fetchMenu();
    };

    // 2. å¾ GAS æŠ“å–èœå–® (è§£æ±º CORS ç”¨çš„ fetch)
    function fetchMenu() {
        // åŠ ä¸Š ?page=json åƒæ•¸
        fetch(GAS_URL + "?page=json")
            .then(res => res.json())
            .then(data => {
                allData = data;
                document.getElementById('store-title').innerText = data.appTitle;
                renderMenu();
                document.getElementById('loader').style.display = 'none';
            })
            .catch(err => {
                alert("è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS ç¶²å€");
                console.error(err);
            });
    }

    // 3. æ¸²æŸ“ç•«é¢
    function renderMenu() {
        const nav = document.getElementById('cat-nav');
        const list = document.getElementById('product-list');
        nav.innerHTML = '<a href="#" class="cat-pill active" onclick="filter(\'all\')">å…¨éƒ¨</a>';
        list.innerHTML = '';

        // åˆ†é¡æŒ‰éˆ•
        allData.categories.forEach(cat => {
            nav.innerHTML += `<a href="#cat-${cat}" class="cat-pill">${cat}</a>`;
            
            // è©²åˆ†é¡å•†å“
            const items = allData.products.filter(p => p.cat === cat);
            let html = `<h5 id="cat-${cat}" class="mt-4 mb-2 fw-bold">${cat}</h5><div class="row g-3">`;
            
            items.forEach(p => {
                const isOOS = p.status === 'oos';
                html += `
                <div class="col-6 col-md-4">
                    <div class="prod-card" onclick="addToCart('${p.name}', ${p.price})">
                        ${p.img ? `<img src="${p.img}" class="prod-img">` : `<div class="prod-img"></div>`}
                        <div class="p-2">
                            <div class="fw-bold">${p.name}</div>
                            <div class="d-flex justify-content-between mt-1">
                                <span class="text-danger fw-bold">$${p.price}</span>
                                ${isOOS ? '<span class="badge bg-secondary">å”®å®Œ</span>' : '<span class="badge bg-danger">+</span>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            list.innerHTML += html;
        });
    }

    // 4. è³¼ç‰©è»Šé‚è¼¯
    function addToCart(name, price) {
        cart.push({ name, price });
        updateCart();
    }

    function updateCart() {
        const total = cart.reduce((sum, item) => sum + item.price, 0);
        document.getElementById('cart-total').innerText = '$' + total;
        document.getElementById('cart-bar').style.display = cart.length > 0 ? 'flex' : 'none';
    }

    // 5. é€å‡ºè¨‚å–® (ä½¿ç”¨ fetch POST)
    function submitOrder() {
        if(!confirm(`ç¢ºå®šé€å‡ºè¨‚å–®ï¼Ÿç¸½é‡‘é¡ $${document.getElementById('cart-total').innerText}`)) return;

        // æ•´ç†å•†å“å­—ä¸²
        const itemsSummary = cart.map(i => i.name).join(', ');
        const total = cart.reduce((sum, item) => sum + item.price, 0);

        const orderData = {
            action: 'createOrder',
            order: {
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                itemsStr: itemsSummary,
                total: total
            }
        };

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('loader').innerHTML = '<div class="spinner-border text-danger"></div><div>è¨‚å–®å‚³é€ä¸­...</div>';

        // ä½¿ç”¨ standard fetch POST
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify(orderData),
            mode: 'no-cors' // ğŸ”´ é—œéµï¼šGAS POST å¿…é ˆç”¨ no-corsï¼Œé›–ç„¶æ‹¿ä¸åˆ°å›å‚³å€¼ï¼Œä½†èƒ½æˆåŠŸé€å‡º
        }).then(() => {
            // å› ç‚º no-cors æ‹¿ä¸åˆ° responseï¼Œæˆ‘å€‘å‡è¨­æˆåŠŸ
            alert("âœ… è¨‚å–®å·²é€å‡ºï¼");
            cart = [];
            updateCart();
            document.getElementById('loader').style.display = 'none';
            // é€™è£¡å¯ä»¥é¸æ“‡é—œé–‰è¦–çª— liff.closeWindow();
        }).catch(err => {
            alert("âŒ ç™¼é€å¤±æ•—");
            console.error(err);
            document.getElementById('loader').style.display = 'none';
        });
    }
</script>

</body>
</html>
